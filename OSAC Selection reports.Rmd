---
title: "OSAC selection reports"
author: "David Keyes"
date: "8/9/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      dpi = 600,
                      fig.align = "center",
                      fig.width = 6,
                      fig.height = 4)

library(tidyverse)
library(googlesheets)
library(readxl)
library(skimr)
library(janitor)
library(splitstackshape)
library(ggmap)
library(scales)
library(extrafont)
library(cowplot)
library(ggridges)
library(patchwork)



```

# Colors + Theme

```{r}

tfff_dark_green <- "#265142"
tfff_light_green <- "#B5CC8E"
tfff_orange <- "#e65100"
tfff_yellow <- "#FBC02D"
tfff_blue <- "#283593"
tfff_red <- "#B71C1C"
tfff_brown <- "#51261C"
tfff_dark_gray <- "#545454"
tfff_medium_gray <- "#a8a8a8"
tfff_light_gray <- "#eeeeee"

source("functions/theme.R")

# Fonts

```{r}

font_import()

```



# Get Data

```{r}

data <- read_excel("data/Ford_Scholar_Data_Reviewed_Interviewed_Awarded_2014-2018.xlsx") %>% 
     clean_names() %>% 
     mutate(year = appyer) %>% 
     mutate(status_calculated = case_when(
          str_detect(status, "Interviewed - Awarded") ~ "Recipient",
          TRUE ~ "Applicant")
     ) %>% 
     mutate(interviewed = case_when(
          str_detect(status, "Not Interviewed") ~ "Not Interviewed",
          TRUE ~ "Interviewed")
     )     %>% 
     mutate(city = str_to_title(city)) 



# Add Zips


us_zips <- read.csv("https://gist.githubusercontent.com/erichurst/7882666/raw/5bdc46db47d9515269ab12ed6fb2850377fd869e/US%2520Zip%2520Codes%2520from%25202013%2520Government%2520Data") %>% 
     set_names(c("zip",
                 "lat",
                 "lon")) 

zips <- data %>% 
     select(zip) %>% 
     distinct(zip) %>% 
     filter(str_length(zip) == 5) %>% 
     mutate(zip = as.integer(zip)) %>% 
     left_join(us_zips, by = "zip")

data <- data %>% 
     left_join(zips, by = "zip")


```

# Geocode
```{r}

register_google(key = "AIzaSyBonrLhrEfIT08lG62TA-KOYoaoghonw4Y")

# High Schools

if (file.exists("data/high_schools.csv")) {
     high_schools <- read_csv("data/high_schools.csv")
} else {
     
     high_schools <- data %>% 
          select(hs_nam, city, st) %>% 
          distinct(hs_nam, .keep_all = T) %>% 
          arrange(hs_nam) %>% 
          filter(hs_nam != "#Deleted") %>% 
          filter(!str_detect(hs_nam, "Any ")) %>% 
          filter(!str_detect(hs_nam, "GED")) %>% 
          filter(!str_detect(hs_nam, "Non-Oregon")) %>% 
          filter(!str_detect(hs_nam, "An Alternative High School--in California")) %>%
          filter(!str_detect(hs_nam, "Unlisted")) %>%
          filter(!str_detect(hs_nam, "High School Completion")) %>%
          filter(!str_detect(hs_nam, "Home School")) %>%
          mutate(str_replace(hs_nam, "(before merger w/Wahtonka)", "")) %>% 
          mutate(state = ifelse(st == "OR", "Oregon", "California")) %>% 
          mutate(address = paste(hs_nam, city, state)) %>% 
          mutate_geocode(address)
     
     write_csv(high_schools, "data/high_schools.csv")
     
}

# Colleges

if (file.exists("data/colleges.csv")) {
     
     colleges <- read_csv("data/colleges.csv")
     
} else {
     
     colleges <- data %>% 
          select(planned_college) %>% 
          unique() %>% 
          arrange(planned_college) %>% 
          mutate_geocode(planned_college)
     
     write_csv(colleges, "data/colleges.csv")
}

# Cities

if (file.exists("data/cities.csv")) {
     cities <- read_csv("data/cities.csv")
} else {
     cities <- data %>% 
          select(city, st) %>% 
          mutate(city = str_to_title(city)) %>% 
          mutate(location = paste(city, st, sep = ", ")) %>% 
          distinct(location, .keep_all = T) %>%  
          arrange(location) %>% 
          mutate_geocode(city)
     
     write_csv(cities, "data/cities.csv")
}





```




# Student Background

## Gender



```{r}
gender <- data %>% 
     select(people_id,
            appyer,
            gender,
            status_calculated) %>% 
     # Need to create gender categories because there are multiple in single cells
     mutate(gender_single = case_when(
          str_detect(gender, paste(c("DI", "TF", "TM", "F, M"), collapse = "|")) ~ "Transgender/Non-Binary",
          str_detect(gender, "N") ~ "Choose not to answer",
          str_detect(gender, "M") ~ "Male",
          str_detect(gender, "F") ~ "Female"
     )) %>% 
     filter(gender_single != "Choose not to answer") %>%
     group_by(appyer, 
              gender_single,
              status_calculated) %>% 
     count() %>% 
     ungroup() %>% 
     group_by(appyer, 
              status_calculated) %>% 
     mutate(pct = prop.table(n)) %>% 
     # Add s onto end of status_calculated so it shows up correctly for facets below
     ungroup() %>% 
     mutate(status_calculated = str_glue("{status_calculated}s")) %>% 
     mutate(gender_single = fct_infreq(gender_single))


ggplot(data = filter(gender, status_calculated == "Applicants"), 
       aes(x = appyer, 
           y = n, 
           fill = gender_single)) +
     geom_area() +
     facet_wrap(~status_calculated,
                ncol = 2,
                scale = "free") +
     tfff_theme +
     labs(y = "Number of Students",
          x = "",
          fill = "") +
     annotate("text",
              x = 2016,
              y = 1700,
              label = "Females",
              color = "white") +
     annotate("text",
              x = 2016,
              y = 500,
              label = "Males",
              color = "white") +
     annotate("text",
              x = 2017,
              y = 1,
              label = str_wrap("Transgender/Non-Binary", 20),
              color = "white") +
     tfff_theme_faceted +  
     scale_fill_manual(values = c(tfff_dark_green,
                                  tfff_light_green,
                                  tfff_yellow,
                                  tfff_orange))


ggplot(data = gender, 
       aes(x = appyer, 
           y = n, 
           fill = gender_single)) +
     geom_area() +
     facet_wrap(~status_calculated,
                ncol = 2,
                scale = "free") +
     tfff_theme +
     labs(y = "Number of Students",
          x = "",
          fill = "") +
     annotate("text",
              x = 2017.5,
              y = max(gender$n),
              label = "test") +
     tfff_theme_faceted +  
     scale_fill_manual(values = c(tfff_dark_green,
                                  tfff_light_green,
                                  tfff_yellow,
                                  tfff_orange))

ggsave("plots/gender.pdf",
       height = 6,
       width = 10,
       device = cairo_pdf)

```

```{r}
names(data)
```




## Race/Ethnicity

Growth of Hispanics

```{r}
ethnic_groups <- tibble(
     code = c("ASIAN",
              "BLACK",
              "HAWAII",
              "HISPAN",
              "MULTI",
              "NATIVE",
              "NOTSAY",
              "OTHER",
              "UNKN",
              "WHITE"),
     group = c("Asian",
               "Black or African-American",
               "Native Hawaiian or Pacific Islander",
               "Hispanic",
               "Multi-Racial",
               "American Indian or Alaska Native",
               "Choose not to say",
               "Other",
               "NOT SELECTED",
               "Caucasian (not Hispanic)")
)

ethnicity <- data %>%
     group_by(year, ethnic_group, status_calculated) %>% 
     summarize(n = n()) %>% 
     ungroup() %>% 
     group_by(year, status_calculated) %>% 
     mutate(pct = prop.table(n)) %>% 
     full_join(ethnic_groups, by = c("ethnic_group" = "code")) %>% 
     na.omit() %>% 
     ungroup() %>% 
     filter(group != "Choose not to say") %>% 
     mutate(status_calculated = str_glue("{status_calculated}s")) %>% 
     mutate(group = str_replace(group,
                                "Caucasian \\(not Hispanic\\)",
                                "White")) %>% 
     mutate(group = str_replace(group,
                                "Black or African-American",
                                "African-American"))

# All in one chart

ggplot(data = ethnicity, 
       aes(x = year, 
           y = n, 
           fill = group)) +
     geom_area() +
     facet_wrap(~status_calculated,
                ncol = 1,
                scale = "free") +
     tfff_theme +
     labs(y = "Number of Students",
          x = "",
          fill = "") +
     theme(legend.position = "right",
           strip.text = element_text(face = "bold",
                                     size = 15)) +
     scale_fill_manual(values = c(tfff_dark_green,
                                  tfff_light_green,
                                  tfff_yellow,
                                  tfff_orange,
                                  tfff_brown,
                                  tfff_blue,
                                  tfff_red))


ggsave("plots/ethnicity.pdf",
       height = 8,
       width = 10,
       device = cairo_pdf)



```


```{r}
# Facetted




ethnicity_plot_applicants <- ethnicity_plot("Applicants") 
ethnicity_plot_recipients <- ethnicity_plot("Recipients") +
     theme(strip.text = element_blank())


ethnicity_plot_applicants + ethnicity_plot_recipients +
     plot_layout(ncol = 1)


ggsave("plots/ethnicity-facetted.pdf",
       height = 6,
       width = 12,
       device = cairo_pdf)

```


## Where From

```{r}
tfff_basemap <- map_data("county") %>% 
     filter(region == "oregon" | subregion == "siskiyou")
```

### Rural

```{r}

data %>% 
     names()

```


### Region

```{r}
data_cities <- data %>% 
     select(status_calculated, city, year) %>% 
     mutate(city = str_to_title(city)) %>% 
     left_join(cities, by = "city") %>% 
     filter(st %in% c("OR", "CA")) %>% 
     # Take the ones below out
     filter(year == 2018)

ggplot(data = data_cities,
       aes(x = lon,
           y = lat),
       color = "red") +
     geom_polygon(data = tfff_basemap,
                  aes(x = long,
                      y = lat,
                      group = group),
                  fill = "#eeeeee",
                  color = "white",
                  size = 1) +
     geom_jitter(color = "red",
                 alpha = .5) +
     coord_map() +
     theme_void() +
     facet_wrap(~status_calculated)

```

```{r}

# By HS


data_hs <- data %>% 
     select(status_awarded, 
            hs_nam, 
            year) %>% 
     group_by(hs_nam, year, status_awarded) %>% 
     summarize(n = n()) %>% 
     left_join(high_schools, by = c("hs_nam" = "name")) %>% 
     filter(!is.na(lon))


ggplot(data = data_hs,
       aes(x = lon,
           y = lat),
       color = "red",
       size = n * 10) +
     geom_polygon(data = tfff_basemap,
                  aes(x = long,
                      y = lat,
                      group = group),
                  fill = "#eeeeee",
                  color = "white",
                  size = 1) +
     geom_jitter(color = "red",
                 alpha = .5) +
     coord_map() +
     theme_void() +
     facet_wrap(~year + status_awarded,
                ncol = 2)

```




### County

```{r}
data_county <- data %>% 
     mutate(county_name = str_to_lower(county_name)) %>% 
     group_by(status_awarded, county_name, year) %>% 
     count() %>% 
     ungroup() %>% 
     group_by(status_awarded, year) %>% 
     mutate(pct = prop.table(n))


ggplot(data = map_county,
       aes(x = long,
           y = lat,
           alpha = pct,
           group = group)) +
     geom_polygon(color = "white",
                  fill = "green") +
     coord_map() +
     theme_void() +
     facet_wrap(~year + status_awarded,
                ncol = 2)


```



# Family

## Expected Family Contribution

## First Generation College

## Parent Education Level



## Parents Marital Status


# Academics

## GPA

### High School - ridgeline

```{r}



data %>% 
     mutate(status_calculated = str_glue("{status_calculated}s")) %>% 
     mutate(year = as.character(appyer)) %>% 
     mutate(status_calculated = fct_rev(status_calculated)) %>% 
     ggplot(aes(x = hsgpa,
                y = year,
                fill = status_calculated)) +
     geom_density_ridges(color = tfff_light_gray) +
     scale_x_continuous(limits = c(1,4.5),
                        breaks = seq(1, 4, by = 1)) +
     facet_wrap(~status_calculated,
                ncol = 2) +
     tfff_theme +
     tfff_theme_faceted +
     labs(title = "GPAs of scholarship recipients tend to be higher than those of applicants") +
     scale_fill_manual(values = c(tfff_light_green,
                                  tfff_dark_green)) +
     theme(legend.position = "none",
           panel.grid.minor.x = element_blank(),
           axis.title = element_blank(),
           plot.title = element_text(face = "bold"),
           strip.text = element_blank())

ggsave("plots/hs-gpa-ridgeline.pdf",
       height = 6,
       width = 8,
       device = cairo_pdf)






```


### High School - histogram

```{r}




hsgpa_plot <- function(group, fill)  {    
     data %>% 
          filter(status_calculated == group) %>%
          ggplot(aes(hsgpa)) +
          geom_histogram(fill = fill) +
          facet_wrap(~appyer,
                     ncol = 5) +
          tfff_theme +
          theme(strip.text = element_blank(),
                legend.position = "none",
                panel.grid.minor.y = element_blank(),
                panel.grid.minor.x = element_blank()) +
          labs(y = "Number of Students",
               x = "GPA",
               fill = "") +
          scale_x_continuous(limits = c(1,4)) 
}



hsgpa_plot_applicant <- hsgpa_plot("Applicant", tfff_dark_green)
hsgpa_plot_recipient <- hsgpa_plot("Recipient", tfff_light_green)

plot_grid(hsgpa_plot_applicant,
          hsgpa_plot_recipient,
          ncol = 1)

ggsave("plots/hs-gpa-histogram.pdf",
       height = 6,
       width = 8,
       device = cairo_pdf)


```


### College

#### SAT

##### Verbal

```{r}


data %>% 
     mutate(status_calculated = str_glue("{status_calculated}s")) %>% 
     mutate(year = as.character(appyer)) %>% 
     mutate(status_calculated = fct_rev(status_calculated)) %>% 
     mutate(sat_verbal = as.numeric(satvrb)) %>% 
     filter(sat_verbal != 0) %>% 
     ggplot(aes(x = sat_verbal,
                y = year,
                fill = status_calculated)) +
     geom_density_ridges(color = tfff_light_gray,
                         size = 1) +
     scale_x_continuous(limits = c(200,800),
                        breaks = seq(200, 800, by = 100)) +
     facet_wrap(~status_calculated,
                ncol = 2) +
     tfff_theme +
     tfff_theme_faceted +
     scale_fill_manual(values = c(tfff_light_green,
                                  tfff_dark_green)) +
     theme(legend.position = "none",
           panel.grid.minor.x = element_blank(),
           axis.title = element_blank(),
           plot.title = element_text(face = "bold"),
           strip.text = element_blank())

ggsave("plots/sat-verbal.pdf",
       height = 6,
       width = 8,
       device = cairo_pdf)
```

##### Math

```{r}


data %>% 
     mutate(status_calculated = str_glue("{status_calculated}s")) %>% 
     mutate(year = as.character(appyer)) %>% 
     mutate(status_calculated = fct_rev(status_calculated)) %>% 
     mutate(sat_math = as.numeric(satmth)) %>% 
     filter(sat_math != 0) %>% 
     ggplot(aes(x = sat_math,
                y = year,
                fill = status_calculated)) +
     geom_density_ridges(color = tfff_light_gray) +
     scale_x_continuous(limits = c(200,800),
                        breaks = seq(200, 800, by = 100)) +
     facet_wrap(~status_calculated,
                ncol = 2) +
     tfff_theme +
     tfff_theme_faceted +
     scale_fill_manual(values = c(tfff_light_green,
                                  tfff_dark_green)) +
     theme(legend.position = "none",
           panel.grid.minor.x = element_blank(),
           axis.title = element_blank(),
           plot.title = element_text(face = "bold"),
           strip.text = element_blank())

ggsave("plots/sat-math.pdf",
       height = 6,
       width = 8,
       device = cairo_pdf)
```

#### ACT

```{r}


data %>% 
     mutate(status_calculated = str_glue("{status_calculated}s")) %>% 
     mutate(year = as.character(appyer)) %>% 
     mutate(status_calculated = fct_rev(status_calculated)) %>% 
     mutate(act = as.numeric(act)) %>% 
     filter(act != 0) %>% 
     ggplot(aes(x = act,
                y = year,
                fill = status_calculated)) +
     geom_density_ridges(color = tfff_light_gray) +
     scale_x_continuous(limits = c(10,40),
                        breaks = seq(10, 40, by = 5)) +
     facet_wrap(~status_calculated,
                ncol = 2) +
     tfff_theme +
     tfff_theme_faceted +
     scale_fill_manual(values = c(tfff_light_green,
                                  tfff_dark_green)) +
     theme(legend.position = "none",
           panel.grid.minor.x = element_blank(),
           axis.title = element_blank(),
           plot.title = element_text(face = "bold"),
           strip.text = element_blank())

ggsave("plots/act.pdf",
       height = 6,
       width = 8,
       device = cairo_pdf)
```



# College Experience

## Intended college
```{r}
intended_college <- data %>% 
     select(people_id, year, status_awarded, planned_college, city) %>% 
     # left_join(cities, by = "city") %>% 
     # select(year, people_id, location, lat.x, lon.x, planned_college, lon.y, lat.y) %>% 
     filter(status_awarded == "Y") %>% 
     group_by(planned_college) %>% 
     count() %>% 
     left_join(colleges, by = "planned_college")  



colleges_basemap <- map_data("state") %>% 
     filter(region %in% c("oregon",
                          "california"))

ggplot(data = intended_college,
       aes(x = lon,
           y = lat,
           size = n),
       color = "red") +
     geom_polygon(data = colleges_basemap,
                  aes(x = long,
                      y = lat,
                      group = group),
                  fill = "#eeeeee",
                  color = "white",
                  size = 1) +
     geom_jitter(color = "red",
                 alpha = .5) +
     coord_map() +
     theme_void() 


```



## Year in College

## Major

```{r}
majors <- data %>% 
     mutate(major = case_when(
          str_detect(major, "Nurs") ~ "Nursing",
          str_detect(major, "Psychology") ~ "Psychology",
          str_detect(major, "Education") ~ "Education",
          str_detect(major, "Biology") ~ "Biology",
          str_detect(major, "Medicine") ~ "Pre-Med",
          str_detect(major, "Engineering") ~ "Engineering",
          str_detect(major, "Business") | str_detect(major, "Accounting") ~ "Business/Accounting",
          TRUE ~ major
     )) %>% 
     mutate(major = str_remove(major, "\\.")) %>% 
     filter(major != "Undecided") %>% 
     # group_by(major) %>% 
     group_by(major, appyer) %>%
     count() %>% 
     ungroup() %>%
     group_by(appyer) %>% 
     arrange(-n) %>% 
     top_n(10)
```




